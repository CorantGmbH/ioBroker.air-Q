{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from '@iobroker/adapter-core';\nimport axios from 'axios';\nimport bonjour, { BrowserConfig } from 'bonjour-service';\nimport * as dns from 'dns';\nimport { decrypt } from './decryptAES256';\n\nclass AirQ extends utils.Adapter {\n\tpublic constructor(options: Partial<utils.AdapterOptions> = {}) {\n\t\tsuper({\n\t\t\t...options,\n\t\t\tname: 'air-q',\n\t\t});\n\t\tthis.on('ready', this.onReady.bind(this));\n\t\tthis.on('stateChange', this.onStateChange.bind(this));\n\t}\n\n\tprivate async onReady(): Promise<void> {\n\n\t\ttry{\n\t\t\tawait this.setObjectNotExistsAsync('Sensors', {\n\t\t\t\ttype: 'device',\n\t\t\t\tcommon: {\n\t\t\t\t\tname: this.config.shortId.concat('_air-Q'),\n\t\t\t\t},\n\t\t\t\tnative: {},\n\t\t\t});\n\t\t}catch(error){\n\t\t\tthis.log.error(error);\n\t\t}\n\n\t\tawait this.setObjectNotExistsAsync(`Sensors.Health`, {\n\t\t\ttype: 'state',\n\t\t\tcommon: {\n\t\t\t\tname: 'Health',\n\t\t\t\ttype: 'number',\n\t\t\t\trole: 'value',\n\t\t\t\tread: true,\n\t\t\t\twrite: true,\n\t\t\t},\n\t\t\tnative: {},\n\t\t});\n\t\tawait this.setObjectNotExistsAsync(`Sensors.Performance`, {\n\t\t\ttype: 'state',\n\t\t\tcommon: {\n\t\t\t\tname: 'Performance',\n\t\t\t\ttype: 'number',\n\t\t\t\trole: 'value',\n\t\t\t\tread: true,\n\t\t\t\twrite: true,\n\t\t\t},\n\t\t\tnative: {},\n\t\t});\n\n\t\tconst service = await this.findAirQInNetwork(this.config.shortId.concat('_air-q'));\n\t\tconst ip = await this.getIp(service.name);\n\t\tconst sensorArray = await this.getSensorsInDevice(ip, this.config.password);\n\n\t\tfor (const element of sensorArray) {\n\t\t\tawait this.setObjectNotExistsAsync(`Sensors.${element}`, {\n\t\t\t\ttype: 'state',\n\t\t\t\tcommon: {\n\t\t\t\t\tname: element,\n\t\t\t\t\ttype: 'number',\n\t\t\t\t\trole: 'value',\n\t\t\t\t\tread: true,\n\t\t\t\t\twrite: true,\n\t\t\t\t},\n\t\t\t\tnative: {},\n\t\t\t});\n\n\t\t\t\t this.subscribeStates(`Sensors.${element}`);\n\t\t}\n\n\t\tthis.setInterval(async () => {\n\t\t\tawait this.setStates(ip, sensorArray);\n\t\t}, this.config.retrievalRate * 1000);\n\t}\n\n\tprivate async findAirQInNetwork(airQName: string): Promise<any> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst instance = new bonjour();\n\t\t\tconst config: BrowserConfig = { type: 'http' };\n\n\t\t\tconst findAirQ = instance.find(config, (service) => {\n\t\t\t\tif (service.name === airQName) {\n\t\t\t\t\tfindAirQ.stop();\n\t\t\t\t\tresolve(service);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tsetTimeout(() => {\n\t\t\t\tfindAirQ.stop();\n\t\t\t\treject(new Error('AirQ not found in network'));\n\t\t\t}, 30000);\n\t\t});\n\t}\n\n\tprivate async getIp(service: any): Promise<string> {\n\t\treturn new Promise<string>((resolve, reject) => {\n\t\t\tdns.lookup(service, 4, (err, address) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(address);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate async getDataFromAirQ(ip: string, password: string): Promise<any> {\n\t\ttry {\n\t\t\tconst response = await axios.get(`http://${ip}/data`, { responseType: 'json' });\n\t\t\tconst data = response.data.content;\n\t\t\tconst decryptedData = decrypt(data, password) as unknown;\n\t\t\tif (decryptedData && typeof decryptedData === 'object') {\n\t\t\t\tconst sensorsData = decryptedData as Sensors;\n\t\t\t\treturn sensorsData;\n\t\t\t} else {\n\t\t\t\tthrow new Error('DecryptedData is undefined or not an object');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate async getAverageDataFromAirQ(ip: string, password: string): Promise<any> {\n\t\ttry {\n\t\t\tconst response = await axios.get(`http://${ip}/average`, { responseType: 'json' });\n\t\t\tconst data = response.data.content;\n\t\t\tconst decryptedData = decrypt(data, password) as unknown;\n\t\t\tif (decryptedData && typeof decryptedData === 'object') {\n\t\t\t\tconst sensorsData = decryptedData as Sensors;\n\t\t\t\treturn sensorsData;\n\t\t\t} else {\n\t\t\t\tthrow new Error('DecryptedData is undefined or not an object');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate async getSensorsInDevice(ip: string, password: string): Promise<string[]> {\n\t\ttry {\n\t\t\tconst response = await axios.get(`http://${ip}/config`, { responseType: 'json' });\n\t\t\tconst data = response.data.content;\n\t\t\tconst decryptedData = decrypt(data, password) as unknown;\n\t\t\tif (decryptedData && typeof decryptedData === 'object') {\n\t\t\t\tconst sensorsData = decryptedData as DataConfig;\n\t\t\t\tconst sensors = sensorsData.sensors;\n\t\t\t\treturn sensors;\n\t\t\t} else {\n\t\t\t\tthrow new Error('DecryptedData is undefined or not an object');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate getRetrievalType(): string {\n\t\treturn this.config.retrievalType;\n\t}\n\n\tprivate onStateChange(id: string, state: ioBroker.State | null | undefined): void {\n\t\tconst value = state?.val;\n\t\tif (state) {\n\t\t\tthis.getStateAsync(id, { val: value, ack: true });\n\t\t} else {\n\t\t\tthis.log.info(`State ${id} deleted`);\n\t\t}\n\t}\n\n\tprivate async setStates(ip: string, sensorArray: string[]): Promise<void> {\n\t\tthis.getRetrievalType() === 'data'\n\t\t\t? this.setSensorData(ip, sensorArray)\n\t\t\t: this.setSensorAverageData(ip, sensorArray);\n\t\tthis.onStateChange('Sensors.Health', await this.getStateAsync('Sensors.Health'));\n\t\tthis.onStateChange('Sensors.Performance', await this.getStateAsync('Sensors.Performance'));\n\t\tfor (const element of sensorArray) {\n\t\t\tconst state = await this.getStateAsync(`Sensors.${element}`);\n\t\t\tthis.onStateChange(`Sensors.${element}`, state);\n\t\t}\n\t}\n\n\tprivate async setSensorData(ip: string, sensorArray: string[]): Promise<void> {\n\t\tconst data = await this.getDataFromAirQ(ip, this.config.password);\n\t\tfor (const element of sensorArray) {\n\t\t\tthis.setStateAsync(`Sensors.${element}`, { val: data[element][0], ack: true });\n\t\t}\n\t\tthis.setStateAsync('Sensors.Health', { val: data.health / 10, ack: true });\n\t\tthis.setStateAsync('Sensors.Performance', { val: data.performance / 10, ack: true });\n\t}\n\n\tprivate async setSensorAverageData(ip: string, sensorArray: string[]): Promise<void> {\n\t\tconst data = await this.getAverageDataFromAirQ(ip, this.config.password);\n\t\tfor (const element of sensorArray) {\n\t\t\tthis.setStateAsync(`Sensors.${element}`, { val: data[element][0], ack: true });\n\t\t}\n\t\tthis.setStateAsync('Sensors.Health', { val: data.health / 10, ack: true });\n\t\tthis.setStateAsync('Sensors.Performance', { val: data.performance / 10, ack: true });\n\t}\n}\n\nif (require.main !== module) {\n\tmodule.exports = (options: Partial<utils.AdapterOptions> | undefined) => new AirQ(options);\n} else {\n\t(() => new AirQ())();\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA,YAAuB;AACvB,mBAAkB;AAClB,6BAAuC;AACvC,UAAqB;AACrB,2BAAwB;AAExB,MAAM,aAAa,MAAM,QAAQ;AAAA,EACzB,YAAY,UAAyC,CAAC,GAAG;AAC/D,UAAM;AAAA,MACL,GAAG;AAAA,MACH,MAAM;AAAA,IACP,CAAC;AACD,SAAK,GAAG,SAAS,KAAK,QAAQ,KAAK,IAAI,CAAC;AACxC,SAAK,GAAG,eAAe,KAAK,cAAc,KAAK,IAAI,CAAC;AAAA,EACrD;AAAA,EAEA,MAAc,UAAyB;AAEtC,QAAG;AACF,YAAM,KAAK,wBAAwB,WAAW;AAAA,QAC7C,MAAM;AAAA,QACN,QAAQ;AAAA,UACP,MAAM,KAAK,OAAO,QAAQ,OAAO,QAAQ;AAAA,QAC1C;AAAA,QACA,QAAQ,CAAC;AAAA,MACV,CAAC;AAAA,IACF,SAAO,OAAN;AACA,WAAK,IAAI,MAAM,KAAK;AAAA,IACrB;AAEA,UAAM,KAAK,wBAAwB,kBAAkB;AAAA,MACpD,MAAM;AAAA,MACN,QAAQ;AAAA,QACP,MAAM;AAAA,QACN,MAAM;AAAA,QACN,MAAM;AAAA,QACN,MAAM;AAAA,QACN,OAAO;AAAA,MACR;AAAA,MACA,QAAQ,CAAC;AAAA,IACV,CAAC;AACD,UAAM,KAAK,wBAAwB,uBAAuB;AAAA,MACzD,MAAM;AAAA,MACN,QAAQ;AAAA,QACP,MAAM;AAAA,QACN,MAAM;AAAA,QACN,MAAM;AAAA,QACN,MAAM;AAAA,QACN,OAAO;AAAA,MACR;AAAA,MACA,QAAQ,CAAC;AAAA,IACV,CAAC;AAED,UAAM,UAAU,MAAM,KAAK,kBAAkB,KAAK,OAAO,QAAQ,OAAO,QAAQ,CAAC;AACjF,UAAM,KAAK,MAAM,KAAK,MAAM,QAAQ,IAAI;AACxC,UAAM,cAAc,MAAM,KAAK,mBAAmB,IAAI,KAAK,OAAO,QAAQ;AAE1E,eAAW,WAAW,aAAa;AAClC,YAAM,KAAK,wBAAwB,WAAW,WAAW;AAAA,QACxD,MAAM;AAAA,QACN,QAAQ;AAAA,UACP,MAAM;AAAA,UACN,MAAM;AAAA,UACN,MAAM;AAAA,UACN,MAAM;AAAA,UACN,OAAO;AAAA,QACR;AAAA,QACA,QAAQ,CAAC;AAAA,MACV,CAAC;AAEC,WAAK,gBAAgB,WAAW,SAAS;AAAA,IAC5C;AAEA,SAAK,YAAY,YAAY;AAC5B,YAAM,KAAK,UAAU,IAAI,WAAW;AAAA,IACrC,GAAG,KAAK,OAAO,gBAAgB,GAAI;AAAA,EACpC;AAAA,EAEA,MAAc,kBAAkB,UAAgC;AAC/D,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACvC,YAAM,WAAW,IAAI,uBAAAA,QAAQ;AAC7B,YAAM,SAAwB,EAAE,MAAM,OAAO;AAE7C,YAAM,WAAW,SAAS,KAAK,QAAQ,CAAC,YAAY;AACnD,YAAI,QAAQ,SAAS,UAAU;AAC9B,mBAAS,KAAK;AACd,kBAAQ,OAAO;AAAA,QAChB;AAAA,MACD,CAAC;AAED,iBAAW,MAAM;AAChB,iBAAS,KAAK;AACd,eAAO,IAAI,MAAM,2BAA2B,CAAC;AAAA,MAC9C,GAAG,GAAK;AAAA,IACT,CAAC;AAAA,EACF;AAAA,EAEA,MAAc,MAAM,SAA+B;AAClD,WAAO,IAAI,QAAgB,CAAC,SAAS,WAAW;AAC/C,UAAI,OAAO,SAAS,GAAG,CAAC,KAAK,YAAY;AACxC,YAAI,KAAK;AACR,iBAAO,GAAG;AAAA,QACX,OAAO;AACN,kBAAQ,OAAO;AAAA,QAChB;AAAA,MACD,CAAC;AAAA,IACF,CAAC;AAAA,EACF;AAAA,EAEA,MAAc,gBAAgB,IAAY,UAAgC;AACzE,QAAI;AACH,YAAM,WAAW,MAAM,aAAAC,QAAM,IAAI,UAAU,WAAW,EAAE,cAAc,OAAO,CAAC;AAC9E,YAAM,OAAO,SAAS,KAAK;AAC3B,YAAM,oBAAgB,8BAAQ,MAAM,QAAQ;AAC5C,UAAI,iBAAiB,OAAO,kBAAkB,UAAU;AACvD,cAAM,cAAc;AACpB,eAAO;AAAA,MACR,OAAO;AACN,cAAM,IAAI,MAAM,6CAA6C;AAAA,MAC9D;AAAA,IACD,SAAS,OAAP;AACD,YAAM;AAAA,IACP;AAAA,EACD;AAAA,EAEA,MAAc,uBAAuB,IAAY,UAAgC;AAChF,QAAI;AACH,YAAM,WAAW,MAAM,aAAAA,QAAM,IAAI,UAAU,cAAc,EAAE,cAAc,OAAO,CAAC;AACjF,YAAM,OAAO,SAAS,KAAK;AAC3B,YAAM,oBAAgB,8BAAQ,MAAM,QAAQ;AAC5C,UAAI,iBAAiB,OAAO,kBAAkB,UAAU;AACvD,cAAM,cAAc;AACpB,eAAO;AAAA,MACR,OAAO;AACN,cAAM,IAAI,MAAM,6CAA6C;AAAA,MAC9D;AAAA,IACD,SAAS,OAAP;AACD,YAAM;AAAA,IACP;AAAA,EACD;AAAA,EAEA,MAAc,mBAAmB,IAAY,UAAqC;AACjF,QAAI;AACH,YAAM,WAAW,MAAM,aAAAA,QAAM,IAAI,UAAU,aAAa,EAAE,cAAc,OAAO,CAAC;AAChF,YAAM,OAAO,SAAS,KAAK;AAC3B,YAAM,oBAAgB,8BAAQ,MAAM,QAAQ;AAC5C,UAAI,iBAAiB,OAAO,kBAAkB,UAAU;AACvD,cAAM,cAAc;AACpB,cAAM,UAAU,YAAY;AAC5B,eAAO;AAAA,MACR,OAAO;AACN,cAAM,IAAI,MAAM,6CAA6C;AAAA,MAC9D;AAAA,IACD,SAAS,OAAP;AACD,YAAM;AAAA,IACP;AAAA,EACD;AAAA,EAEQ,mBAA2B;AAClC,WAAO,KAAK,OAAO;AAAA,EACpB;AAAA,EAEQ,cAAc,IAAY,OAAgD;AACjF,UAAM,QAAQ,+BAAO;AACrB,QAAI,OAAO;AACV,WAAK,cAAc,IAAI,EAAE,KAAK,OAAO,KAAK,KAAK,CAAC;AAAA,IACjD,OAAO;AACN,WAAK,IAAI,KAAK,SAAS,YAAY;AAAA,IACpC;AAAA,EACD;AAAA,EAEA,MAAc,UAAU,IAAY,aAAsC;AACzE,SAAK,iBAAiB,MAAM,SACzB,KAAK,cAAc,IAAI,WAAW,IAClC,KAAK,qBAAqB,IAAI,WAAW;AAC5C,SAAK,cAAc,kBAAkB,MAAM,KAAK,cAAc,gBAAgB,CAAC;AAC/E,SAAK,cAAc,uBAAuB,MAAM,KAAK,cAAc,qBAAqB,CAAC;AACzF,eAAW,WAAW,aAAa;AAClC,YAAM,QAAQ,MAAM,KAAK,cAAc,WAAW,SAAS;AAC3D,WAAK,cAAc,WAAW,WAAW,KAAK;AAAA,IAC/C;AAAA,EACD;AAAA,EAEA,MAAc,cAAc,IAAY,aAAsC;AAC7E,UAAM,OAAO,MAAM,KAAK,gBAAgB,IAAI,KAAK,OAAO,QAAQ;AAChE,eAAW,WAAW,aAAa;AAClC,WAAK,cAAc,WAAW,WAAW,EAAE,KAAK,KAAK,SAAS,IAAI,KAAK,KAAK,CAAC;AAAA,IAC9E;AACA,SAAK,cAAc,kBAAkB,EAAE,KAAK,KAAK,SAAS,IAAI,KAAK,KAAK,CAAC;AACzE,SAAK,cAAc,uBAAuB,EAAE,KAAK,KAAK,cAAc,IAAI,KAAK,KAAK,CAAC;AAAA,EACpF;AAAA,EAEA,MAAc,qBAAqB,IAAY,aAAsC;AACpF,UAAM,OAAO,MAAM,KAAK,uBAAuB,IAAI,KAAK,OAAO,QAAQ;AACvE,eAAW,WAAW,aAAa;AAClC,WAAK,cAAc,WAAW,WAAW,EAAE,KAAK,KAAK,SAAS,IAAI,KAAK,KAAK,CAAC;AAAA,IAC9E;AACA,SAAK,cAAc,kBAAkB,EAAE,KAAK,KAAK,SAAS,IAAI,KAAK,KAAK,CAAC;AACzE,SAAK,cAAc,uBAAuB,EAAE,KAAK,KAAK,cAAc,IAAI,KAAK,KAAK,CAAC;AAAA,EACpF;AACD;AAEA,IAAI,QAAQ,SAAS,QAAQ;AAC5B,SAAO,UAAU,CAAC,YAAuD,IAAI,KAAK,OAAO;AAC1F,OAAO;AACN,GAAC,MAAM,IAAI,KAAK,GAAG;AACpB;",
  "names": ["bonjour", "axios"]
}
